# Keybindings
# https://wiki.hyprland.org/Configuring/Binds/
# https://wiki.hypr.land/Configuring/Window-Rules/
# regex notation Google RE2 https://github.com/google/re2/wiki/Syntax

$setUSLayout = hyprctl switchxkblayout $(hyprctl -j devices | jq -r '.keyboards | .[] | select(.main == true) | .name') 0
# debug actions
bind = SUPER_ALT, 1, exec, export > /tmp/hypr_envs # all exported env vars

# load custom machine config
source = ~/.config/hypr/$MACHINE_ID/binds.conf # MACHINE_ID from /etc/environment

# no gaps когда одно окно https://wiki.hyprland.org/Configuring/Workspace-Rules/#smart-gaps
# должно быть до всех правил про workspace
workspace = w[tv1], gapsout:0, gapsin:0
workspace = f[1], gapsout:0, gapsin:0
windowrule {
  name = windowrule-1
  border_size = 0
  match:float = 0
  match:workspace = w[tv1]
}

windowrule {
  name = windowrule-2
  border_size = 0
  match:float = 0
  match:workspace = f[1]
}

bindd = SUPER, 1, Switch to workspace, workspace, 1
bindd = SUPER, 2, Switch to workspace, workspace, 2
bindd = SUPER, 3, Switch to workspace, workspace, 3
bindd = SUPER, 4, Switch to workspace, workspace, 4
bindd = SUPER, 5, Switch to workspace, workspace, 5
bindd = SUPER, 6, Switch to workspace, workspace, 6
bindd = SUPER, 7, Switch to workspace, workspace, 7
bindd = SUPER, 8, Switch to workspace, workspace, 8
bindd = SUPER, 9, Switch to workspace, workspace, 9
bindd = SUPER, 0, Switch to workspace, workspace, 10

bindd = SUPER_CTRL, 1, Move to workspace, movetoworkspacesilent, 1
bindd = SUPER_CTRL, 2, Move to workspace, movetoworkspacesilent, 2
bindd = SUPER_CTRL, 3, Move to workspace, movetoworkspacesilent, 3
bindd = SUPER_CTRL, 4, Move to workspace, movetoworkspacesilent, 4
bindd = SUPER_CTRL, 5, Move to workspace, movetoworkspacesilent, 5
bindd = SUPER_CTRL, 6, Move to workspace, movetoworkspacesilent, 6
bindd = SUPER_CTRL, 7, Move to workspace, movetoworkspacesilent, 7
bindd = SUPER_CTRL, 8, Move to workspace, movetoworkspacesilent, 8
bindd = SUPER_CTRL, 9, Move to workspace, movetoworkspacesilent, 9
bindd = SUPER_CTRL, 0, Move to workspace, movetoworkspacesilent, 10

# Switch windows # windows like switch
$scriptDir = ~/.config/hypr/scripts
bind = ALT, Tab, cyclenext, prev
bind = ALT, Tab, exec, $scriptDir/alt_tab_press.sh
bind = ALT_SHIFT, Tab, cyclenext,
bind = ALT_SHIFT, Tab, exec, $scriptDir/alt_tab_press.sh
bindrt = ALT, ALT_L, exec, $scriptDir/alt_release.sh
bindrt = SHIFT, SHIFT_L, exec, $scriptDir/alt_release.sh

bindm = SUPER, mouse:272, movewindow
bindm = SUPER, mouse:273, resizewindow

# move focus SUPER+Arrow
bindd = SUPER, LEFT, Move focus left, movefocus, l
bindd = SUPER, RIGHT, Move focus right, movefocus, r
bindd = SUPER, UP, Move focus up, movefocus, u
bindd = SUPER, DOWN, Move focus down, movefocus, d

# move window SUPER+Ctrl+Arrow
bindd = SUPER_CTRL, LEFT, Move window left, movewindow, l
bindd = SUPER_CTRL, RIGHT, Move window right, movewindow, r
bindd = SUPER_CTRL, UP, Move window up, movewindow, u
bindd = SUPER_CTRL, DOWN, Move window down, movewindow, d

# resize window SUPER+Shift+Arrow
binded = SUPER_SHIFT, RIGHT, Resize right, resizeactive, 10 0
binded = SUPER_SHIFT, left, Resize left, resizeactive, -10 0
binded = SUPER_SHIFT, up, Resize up, resizeactive, 0 -10
binded = SUPER_SHIFT, down, Resize down, resizeactive, 0 10

# Audio
$getVolume = wpctl get-volume @DEFAULT_AUDIO_SINK@ | sed "s/Volume: //" | sed "s/0\.//" | tr --delete "."
bindld  = , XF86AudioMicMute, Microphone mute, exec, wpctl set-mute @DEFAULT_AUDIO_SOURCE@ toggle
bindld  = , XF86AudioMute, Output mute, exec, wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle
bindeld = , XF86AudioRaiseVolume, Volume+, exec, bash -c 'v=$($getVolume); [[ $v -lt 150 ]] && ((v += 10)) && wpctl set-volume @DEFAULT_AUDIO_SINK@ 10%+; echo $v > $WOBSOCK'
bindeld = , XF86AudioLowerVolume, Volume-, exec, wpctl set-volume @DEFAULT_AUDIO_SINK@ 10%- && echo $($getVolume) > $WOBSOCK
bindld  = , XF86AudioPlay, Play, exec, playerctl play-pause
bindld  = , XF86AudioPause, Pause, exec, playerctl play-pause
bindld  = , XF86AudioNext, Next track, exec, playerctl next
bindld  = , XF86AudioPrev, Previous track, exec, playerctl previous

bindd = ALT, F4, Kill window on focus, exec, hyprctl dispatch killactive ""
bindd = SUPER, F, Toggle fullscreen, fullscreen, 0
bindd = SUPER, delete, Exit hyperland, exec, hyprctl dispatch exit
# bindd = SUPER, F, Toggle window on focus float, togglefloating
bindd = SUPER, L, Lock screen, exec, swaylock
bindd = CTRL_ALT, L, Lock screen, exec, swaylock
bindd = CTRL_ALT, DELETE, Logout or restart, exec, pkill -x wlogout || wlogout --buttons-per-row 4 --margin 0 --layout "$HOME/.config/wlogout/layout" --css "$HOME/.config/wlogout/style.css" --protocol layer-shell

bindd = , Print, Make Screenshot, exec, grim -g "$(slurp)" - | swappy -f -
bindd = ALT, Print, Copy pixel color, exec, hyprpicker --autocopy --no-fancy

$getProxyPAC = base64 -w0 ~/proxy.pac
bindd = SUPER, B, Google chrome, exec, uwsm app -- google-chrome-stable --class="google-chrome" --proxy-pac-url='data:application/x-javascript-config;base64,'$($getProxyPAC)
bindd = SUPER_ALT, B, Brave browser, exec, uwsm app -- brave --proxy-server="socks5://127.0.0.1:2080"
bindd = SUPER, T, Lunch foot terminal, exec, foot
bindd = SUPER, I, Window info, exec, hyprctl activewindow -j | foot sh -c 'jq --sort-keys --color-output < /proc/$PPID/fd/0 | less --RAW-CONTROL-CHARS'
bindd = SUPER, tab, Show notifications, exec, swaync-client --toggle-panel --skip-wait
bindd = SUPER, SUPER_R, App launcher, exec, pkill -x anyrun || anyrun --plugins libapplications.so
bindd = ALT, F2, Lunch asddoc, exec, asddoc_rofi -e 'code --ozone-platform-hint=auto' && hypr_activate_ws_if_exists special:codium
bindd = CTRL, ESCAPE, Htop, exec, hypr_start_move_kill 'kitty --class=sysmonitor htop' sysmonitor

# у workspace при rounding:false начинает просвечивать верхняя грань htop

bindd = CTRL, grave, Switch to terminal workspace, togglespecialworkspace, terminal
bindd = SUPER_CTRL, grave, Move to terminal workspace, movetoworkspacesilent, special:terminal
workspace = special:terminal, rounding:true, gapsout:300 150 -4, on-created-empty: ghostty --class=my.terminal

bindd = , Pause, Toggle notes worspace, togglespecialworkspace, codium
bindd = SUPER_CTRL, Pause, Move to notes worspace, movetoworkspacesilent, special:codium
workspace = special:codium, rounding:true, gapsout:300 100 50, on-created-empty: code --ozone-platform-hint=auto

bindd = SUPER, F1, Toggle throne worspace, togglespecialworkspace, throne
bindd = SUPER_CTRL, F1, Move to throne worspace, movetoworkspacesilent, special:throne
workspace = special:throne, rounding:true, gapsout:50, on-created-empty: uwsm app -- throne
windowrule {
  name = telegram
  match:class = ^Throne$

  workspace = special:throne
}

bindd = , Scroll_Lock, Toggle telegram worspace, togglespecialworkspace, telegram
bindd = SUPER_CTRL, Scroll_Lock, Move to telegram workspace, movetoworkspacesilent, special:telegram
workspace = special:telegram, rounding:true, gapsout:70, on-created-empty: uwsm app -- /usr/share/applications/org.telegram.desktop.desktop
windowrule {
  name = telegram
  match:class = ^org.telegram.desktop$

  workspace = special:telegram
}

windowrule {
  name = telegram-viewer
  match:class = ^org.telegram.desktop$
  match:title = ^Media viewer$

  float = on
  size = monitor_w monitor_h-33
  move = 0 0
  border_size = 0
}

# Network Manager applet connection editor
windowrule {
  name = nm-connection-editor
  float = on
  match:class = ^nm-connection-editor$
}

# htop
windowrule {
  name = sysmonitor
  float = on
  center = 1
  size = (monitor_w*0.75) (monitor_h*0.75)
  match:class = ^sysmonitor$
}

# windowrule {
#   name = windowrule-7
#   rounding = 1
#   match:class = ^sysmonitor$ # rounding 0 начинает просвечивать десктоп через вернюю грань на темном фоне
# }

# qBittorrent
windowrule {
  name = windowrule-8
  float = on
  match:class = ^org.qbittorrent.qBittorrent$
  match:title = '^[^q][^B][^i][^t]' # основное окно имеет title qBittorrent v5.1.2 - его не флоатить
}

windowrule {
  name = windowrule-9
  size = (monitor_w*0.65) (monitor_h*0.65)
  center = 1
  match:class = ^org.qbittorrent.qBittorrent$
}

windowrule {
  name = xdg-desktop-portal-gtk
  match:class = ^xdg-desktop-portal-gtk$

  tag = +xdg-desktop-portal
}

windowrule {
  name = xdg-desktop-portal-params
  match:tag = xdg-desktop-portal

  stay_focused = on
  float = on
  size = monitor_w*0.4 monitor_h*0.6
  center = on
}

# # open file
# windowrule {
#   name = windowrule-5
#   match:class = ^Codium$
#   match:title = ^Open File$
#   match:float = 1

#   center = 1
#   size = 950 750
# }

# Unable to open Create File?
# Do you want to save?
# windowrule {
  # name = windowrule-6
  # match:class = ^electron$
  # match:title = ^Code - OSS$
  # match:float = 1
  # match:workspace = special:codium

  # tag = +vscode
  # size = 750 750
  # stay_focused = on
  # no_follow_mouse = on
# }

windowrule {
  name = vscode-save-changed-tag
  match:class = ^electron$
  match:title = ^Code - OSS$
  match:float = true

  tag = +vscode-save
}

windowrule {
  name = vscode-save-changed-params
  match:tag = vscode-save

  stay_focused = on
}

windowrule {
  name = blueman-manager
  match:class = ^blueman-manager$

  float = on
  size = 750 750
}

windowrule {
  name = pavucontrol-qt
  match:class = ^pavucontrol-qt$

  float = on
  size = 750 750
  stay_focused = on
}

windowrule {
  name = qt5ct
  match:class = ^qt5ct$

  float = on
  size = 750 750
  center = 1
}

windowrule {
  name = qt6ct
  match:class = ^qt6ct$

  float = on
}

# windowrule {
#   name = throne
#   match:class = ^Throne$

#   workspace = special:throne
# }

windowrule {
  name = calculator
  match:class = ^org.gnome.Calculator$

  float = on
  size = 550 850
  center = 1
}

windowrule {
  name = waypaper
  match:class = ^waypaper$

  float = on
}

windowrule {
  name = kdeconnect
  match:class = ^org.kde.kdeconnect-indicator$

  float = on
}

windowrule {
  name = windowrule-18
  match:class = ^nmtui$

  float = on
  center = 1
  size = 560 760
  dim_around = on
}

windowrule {
  name = kwalletd5
  match:class = ^org.kde.kwalletd5$

  center = 1
  dim_around = on
}

windowrule {
  name = kdeconnect
  match:class = ^org.kde.kdeconnect.handler$
  match:title = ^KDE Connect URL handler$

  float = on
  center = 1
  size = 500 185
}

# windowrule {
#   name = mpv
#   match:class = ^mpv$

#   workspace = 4
# }

windowrule {
  name = goland-feedback-workspace-2
  match:class = ^jetbrains-goland$
  match:title = ^Feedback$
  match:float = 1

  workspace = 2
}

windowrule {
  name = goland-conflicts-worspace-2
  match:class = ^jetbrains-goland$
  match:title = ^File Cache Conflict$
  match:float = 1

  workspace = 2
}

# jetbrains fix omarchy. From ~/.local/share/omarchy/default/hypr/apps/jetbrains.conf

windowrule {
  name = jetbrains-splash-tag
  match:class = ^(jetbrains-.*)$
  match:title = ^(splash)$
  match:float = 1

  tag = +jetbrains-splash
}
# splash не забирает фокус
windowrule {
  name = jetbrains-splash-tag-params
  match:tag = jetbrains-splash

  no_focus = on
  center = on
  border_size = 0
}


# Center popups/find windows
windowrule {
  name = jetbrains-float-emptytitle-tag
  match:class = ^(jetbrains-.*)
  match:title = ^(\s*)$
  match:float = 1

  tag = +jetbrains-float-emptytitle
  min_size = (monitor_w*0.5) (monitor_h*0.5)
}

# все jetbrains держит фокус
windowrule {
  name = jetbrains-tag-params
  match:tag = jetbrains-float-emptytitle

  stay_focused = on
  center = on
  border_size = 0
}

# Enabling this makes it possible to provide input in popup dialogs (search window, new file, etc.)
# For some reason tag:jetbrains does not work for size rule
# Disable window flicker when autocomplete or tooltips appear
windowrule {
  name = jetbrains-wintitle-float-tag
  match:class = ^(jetbrains-.*)$
  match:title = ^(win.*)$
  match:float = 1

  no_initial_focus = on
  tag = +jetbrains-wintitle-float
}

# Disable mouse focus
windowrule {
  name = jetbrains-tag
  match:class = ^(jetbrains-.*)$

  no_follow_mouse = on
  tag = +jetbrains
}

# --------- jetbrains

windowrule {
  name = grapted
  match:class = ^GParted$
  match:float = true

  stay_focused = on
  no_follow_mouse = on
}

# no_follow_mouse - Prevents the window from being focused when the mouse moves over it when input:follow_mouse=1 is set.
# no_initial_focus - Disables the initial focus to the window
# stay_focused - Forces focus on the window as long as it’s visible.
# no_focus - Disables focus to the window.
