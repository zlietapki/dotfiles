#!/usr/bin/env bash

usage() {
    echo "Convert document name to its absolute filepath and open it."
    echo
    echo "Usage: asddoc [-d|--dir=] <document>" 1>&2;
    echo "  OPTIONS:"
    echo "  -d DIR, --dir=DIR Set document dir to DIR (default is ~/Dropbox)"
    echo "  -p --print-only Print absolute path only"
    echo "  -e --editor Use editor (\$EDITOR is default)"
    echo "  -h, --help This message"
    exit 1;
}
doc2path() { # document basedir - возваращает абсолютный путь
    local names
    IFS='/' read -ra names <<< "$1"
    case ${#names[@]} in
        1) echo "${2}/${names[0]}/${names[0]}.md";;
        2) echo "${2}/${names[0]}/${names[1]}.md";;
        *)
            >&2 echo "Tree deeper then 2 is not suppoted"; # stderr
            exit 1;
        ;;
    esac
}

TEMP=$(getopt --options d:pe:h --longoptions dir:,help --name 'asddoc' -- "$@") || exit 1;
eval set -- "$TEMP"

DIR=$HOME/Dropbox
PRINT_ONLY=
ED=$EDITOR
while true; do
  case "$1" in
    -d | --dir ) DIR="$2"; shift 2;;
    -p | --print-only ) PRINT_ONLY=1; shift;;
    -e | --editor ) ED="$2"; shift 2;;
    -h | --help ) usage;;
    -- ) shift; break;;
    * ) break;;
  esac
done

DOC=$1
if [ -z "$DOC" ]; then
    usage;
fi

doc=$(doc2path "$DOC" "$DIR") || exit 1;

if [[ $PRINT_ONLY == 1 ]]; then
    echo "$doc";
    exit;
fi

$ED "$doc"
